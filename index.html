<!doctype html>
<html lang="ar" dir="rtl" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISS‑25 Explorer — الذكرى الخامسة والعشرون لمحطة الفضاء الدولية</title>
  <meta name="description" content="موقع تفاعلي حديث يستعرض 25 عامًا من محطة الفضاء الدولية مع تتبع حيّ، خط زمني بصري، وتبديل الوضع ليل/نهار ودعم العربية والإنجليزية." />
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config (optional brand palette)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            space: {
              50: '#f5f7ff', 100: '#e9edff', 200: '#cfd9ff', 300: '#a6baff',
              400: '#7d95ff', 500: '#506cff', 600: '#3a4fe0', 700: '#2939b3',
              800: '#1c2a80', 900: '#0f1b57', 950: '#0a133c'
            }
          },
          boxShadow: {
            glow: '0 0 40px rgba(99,102,241,.25)'
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <!-- Leaflet & satellite.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
  <!-- Three.js for 360 viewer -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
  <style>
    /* Glassmorphism helpers */
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    /* تأكد من أن عنصر الخريطة له أبعاد مناسبة */
    #map { min-height: 400px; }
   
    /* إصلاح مشاكل RTL مع Leaflet */
    .leaflet-container { direction: ltr; }
    .leaflet-control { direction: rtl; }

    /* ISS marker animation */
    .iss-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.5), 0 0 20px 6px rgba(59,130,246,0.4);
      animation: pulse 2s infinite;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .iss-icon::after {
      content: "";
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.7); }
      70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
    }

    /* تنسيق الصور في الخط الزمني */
    .timeline-image {
      transition: transform 0.3s ease;
    }
    .timeline-card:hover .timeline-image {
      transform: scale(1.05);
    }

    /* أنماط إضافية للنموذج 360 */
    #cupola-container {
      width: 100%;
      height: 500px;
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
    }
    
    .cupola-info {
      position: absolute;
      top: 20px;
      right: 20px;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }

    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .viewer-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    
    .viewer-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .viewer-btn:hover {
      background: rgba(59, 130, 246, 0.7);
    }

    .scene-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .scene-btn {
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scene-btn:hover {
      background: rgba(59, 130, 246, 0.7);
    }

    .scene-btn.active {
      background: rgba(59, 130, 246, 0.9);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    .zoom-controls {
      position: absolute;
      right: 20px;
      bottom: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .zoom-btn {
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .zoom-btn:hover {
      background: rgba(59, 130, 246, 0.7);
    }

    .video-controls {
      position: absolute;
      left: 20px;
      bottom: 20px;
      z-index: 1000;
      display: flex;
      gap: 5px;
    }

    .video-btn {
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-btn:hover {
      background: rgba(59, 130, 246, 0.7);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-space-950 to-black text-white selection:bg-indigo-500/40">
  <!-- Header / Navbar -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-black/40 glass">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-indigo-500/20 flex items-center justify-center shadow-glow">
          <!-- simple rocket icon -->
          <svg class="h-5 w-5 text-indigo-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M6 12c-2.5 1.5-3 4.5-3 4.5s3-0.5 4.5-3M12 6c1-4 6-4 6-4s0 5-4 6M8 16l8-8"/>
            <path d="M14 10a2 2 0 1 0-4 0 2 2 0 0 0 4 0z"/>
          </svg>
        </div>
        <div>
          <p class="text-sm text-white/70" data-i18n="brand_over">مشروع ويب تفاعلي</p>
          <h1 class="font-semibold tracking-tight" data-i18n="brand_title">ISS‑25 Explorer</h1>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-white/80">
        <a href="#mapwrap" class="hover:text-white transition" data-i18n="nav_track">التتبّع الحيّ</a>
        <a href="#timeline" class="hover:text-white transition" data-i18n="nav_timeline">الخط الزمني</a>
        <a href="#cupola" class="hover:text-white transition" data-i18n="nav_cupola">قبة المحطة</a>
        <a href="#life" class="hover:text-white transition" data-i18n="nav_life">الحياة على متن ISS</a>
      </nav>
      <div class="flex items-center gap-2">
        <!-- Language toggle -->
        <button id="langToggle" class="glass border border-white/10 rounded-xl px-3 py-2 text-sm text-white/90 hover:bg-white/10 transition" aria-label="Toggle language">AR</button>
        <!-- Theme toggle -->
        <button id="themeToggle" class="glass border border-white/10 rounded-xl p-2 text-white/90 hover:bg-white/10 transition" aria-label="Toggle theme">
          <span id="themeIcon" aria-hidden="true">🌙</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10 lg:py-16">
      <div class="grid lg:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight">
            <span data-i18n="hero_h1_1">25 عامًا في المدار</span>
            <span class="block text-indigo-300" data-i18n="hero_h1_2">محطة الفضاء الدولية</span>
          </h2>
          <p class="mt-4 text-white/80" data-i18n="hero_sub">استكشف تاريخ وإنجازات ISS عبر تتبّع حيّ، خط زمني بصري، وقصص من الحياة اليومية على متن المحطة — كل ذلك في تجربة ويب أنيقة.</p>
          <div class="mt-6 flex gap-3">
            <a href="#mapwrap" class="inline-flex items-center gap-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 shadow-glow transition" data-i18n="cta_track">ابدأ التتبّع</a>
            <a href="#cupola" class="inline-flex items-center gap-2 rounded-xl border border-white/15 hover:border-white/25 px-4 py-2 text-white/90 glass" data-i18n="cta_cupola">استكشف القبة</a>
          </div>
        </div>
        <div class="relative">
          <div class="absolute -inset-6 bg-gradient-to-br from-indigo-500/20 via-cyan-400/10 to-transparent rounded-[2rem] blur-2xl"></div>
          <div  id="issw" class="relative glass border border-white/10 rounded-3xl p-3" > 
           <iframe width="560" height="400" src="https://www.youtube.com/embed/yf5cEJULZXk" title="Live High-Definition Views from the International Space Station (Official NASA Stream)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Cupola 360 Section -->
  <section id="cupola" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-8">
      <h2 class="text-2xl sm:text-3xl font-bold" data-i18n="cupola_title">تجربة قبة المحطة الفضائية (Cupola)</h2>
      <p class="text-white/70 mt-2" data-i18n="cupola_sub">استكشف منظرًا بانوراميًا 360 درجة من القبة، النافذة الأكثر تميزًا على العالم في محطة الفضاء الدولية</p>
    </div>
    
    <div class="glass border border-white/10 rounded-3xl overflow-hidden relative">
      <div id="cupola-container">
        <div id="loading-overlay">
          <div class="loader"></div>
        </div>
      </div>
      <div class="cupola-info">
        <h3 class="font-semibold" data-i18n="cupola_info_title">معلومات عن القبة</h3>
        <p class="text-sm text-white/80 mt-2" data-i18n="cupola_info_text">تمتلك القبة 7 نوافذ وتوفر منظرًا استثنائيًا للأرض. تستخدم لمراقبة عمليات السير في الفضاء وتوجيه الذراع الروبوتية.</p>
      </div>
      
      <!-- عناصر التحكم في المشاهد -->
      <div class="scene-controls">
        <button id="scene1" class="scene-btn active" title="فيديو القبة 1">▶️</button>
        <button id="scene2" class="scene-btn" title="فيديو القبة 2">🌎</button>
        <button id="scene3" class="scene-btn" title="صورة القبة 1">🖼️</button>
        <button id="scene4" class="scene-btn" title="صورة القبة 2">📷</button>
      </div>
      
      <!-- عناصر التحكم في التكبير/التصغير -->
      <div class="zoom-controls">
        <button id="zoom-in" class="zoom-btn" title="تكبير">+</button>
        <button id="zoom-out" class="zoom-btn" title="تصغير">-</button>
      </div>
      
      <!-- عناصر التحكم في الفيديو -->
      <div class="video-controls">
        <button id="play-pause" class="video-btn" title="تشغيل/إيقاف">⏯️</button>
        <button id="mute-unmute" class="video-btn" title="كتم/إلغاء كتم">🔇</button>
      </div>
      
      <!-- عناصر التحكم العامة -->
      <div class="viewer-controls">
        <button id="auto-rotate" class="viewer-btn" data-i18n="cupola_auto_rotate">تدوير تلقائي</button>
        <button id="reset-view" class="viewer-btn" data-i18n="cupola_reset">إعادة الضبط</button>
        <button id="fullscreen" class="viewer-btn" data-i18n="cupola_fullscreen">ملء الشاشة</button>
      </div>
    </div>
    
    <div class="grid md:grid-cols-2 gap-6 mt-8">
      <div class="glass border border-white/10 rounded-2xl p-4">
        <h3 class="font-semibold mb-2" data-i18n="cupola_usage_title">استخدامات القبة</h3>
        <ul class="text-white/80 space-y-2 text-sm">
          <li data-i18n="cupola_usage1">مراقبة الأرض والظواهر الطبيعية</li>
          <li data-i18n="cupola_usage2">توجيه العمليات الخارجية والذراع الآلية</li>
          <li data-i18n="cupola_usage3">التصوير الفلكي والبحث العلمي</li>
          <li data-i18n="cupola_usage4">إجراء تجارب الرصد الأرضي</li>
        </ul>
      </div>
      <div class="glass border border-white/10 rounded-2xl p-4">
        <h3 class="font-semibold mb-2" data-i18n="cupola_facts_title">حقائق عن القبة</h3>
        <ul class="text-white/80 space-y-2 text-sm">
          <li data-i18n="cupola_fact1">أضيفت إلى المحطة في عام 2010</li>
          <li data-i18n="cupola_fact2">النافذة المركزية يبلغ قطرها 80 سم</li>
          <li data-i18n="cupola_fact3">صممت وبنيت بواسطة وكالة الفضاء الأوروبية</li>
          <li data-i18n="cupola_fact4">توفر رؤية بزاوية 360 درجة حول المحطة</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- باقي المحتوى الأصلي -->
  <!-- Map + Sidebar -->
  <main id="mapwrap" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-12 grid lg:grid-cols-[minmax(0,1fr)_380px] gap-6">
    <!-- Map card -->
    <section class="glass border border-white/10 rounded-3xl overflow-hidden">
      <div class="p-4 flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold" data-i18n="map_title">التتبّع الحيّ للمحطة</h3>
          <p class="text-sm text-white/70" data-i18n="map_sub">موقع لحظي + مسار قادم محسوب محليًا من عناصر المدار (TLE)</p>
        </div>
        <div class="text-xs text-white/60">NORAD 25544</div>
      </div>
      <div id="map" class="h-[64vh] w-full"></div>
      <div class="p-4 grid grid-cols-2 gap-2 text-xs text-white/60">
        <div><span class="font-medium">خط العرض:</span> <span id="iss-lat">--</span></div>
        <div><span class="font-medium">خط الطول:</span> <span id="iss-lng">--</span></div>
        <div><span class="font-medium">الارتفاع:</span> <span id="iss-alt">--</span> كم</div>
        <div><span class="font-medium">السرعة:</span> <span id="iss-vel">--</span> كم/س</div>
      </div>
      <div class="p-4 text-xs text-white/60">
        <span data-i18n="map_src">المصدر: wheretheiss.at للموقع الحيّ، CelesTrak + satellite.js للمسار، خرائط OpenStreetMap/Carto.</span>
      </div>
    </section>

    <!-- Sidebar: Timeline & Life Aboard -->
    <aside class="space-y-6">
      <section class="glass border border-white/10 rounded-3xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold" data-i18n="timeline_title">الخط الزمني (2000 → 2025)</h3>
          <button id="reloadTimeline" class="text-xs px-2 py-1 rounded-lg border border-white/15 hover:border-white/30 glass" data-i18n="reload">تحديث</button>
        </div>
        <div id="timeline" class="grid grid-cols-1 gap-3"></div>
      </section>

      <section id="life" class="glass border border-white/10 rounded-3xl p-4">
        <h3 class="text-lg font-semibold mb-2" data-i18n="life_title">الحياة على متن ISS</h3>
        <ul class="grid gap-2">
          <li class="rounded-xl border border-white/10 p-3 hover:bg-white/5 transition">
            <span class="font-medium" data-i18n="life_sleep_t">النوم في الجاذبية الصغرى</span>
            <p class="text-white/70 text-sm" data-i18n="life_sleep_d">أكياس نوم مثبتة على الجدران لتفادي الطفو أثناء النوم.</p>
          </li>
          <li class="rounded-xl border border-white/10 p-3 hover:bg-white/5 transition">
            <span class="font-medium" data-i18n="life_ex_t">التمارين اليومية</span>
            <p class="text-white/70 text-sm" data-i18n="life_ex_d">أجهزة مقاومة وجري للمحافظة على العظام والعضلات.</p>
          </li>
          <li class="rounded-xl border border-white/10 p-3 hover:bg-white/5 transition">
            <span class="font-medium" data-i18n="life_food_t">الطعام</span>
            <p class="text-white/70 text-sm" data-i18n="life_food_d">وجبات معبأة خصيصًا وتُسخّن بمعدات مدمجة.</p>
          </li>
          <li class="rounded-xl border border-white/10 p-3 hover:bg-white/5 transition">
            <span class="font-medium" data-i18n="life_research_t">التجارب العلمية</span>
            <p class="text-white/70 text-sm" data-i18n="life_research_d">أبحاث في الطب والمواد والبيولوجيا ببيئة انعدام الوزن.</p>
          </li>
        </ul>
      </section>
    </aside>
  </main>

  <footer class="border-t border-white/10 py-6 text-center text-white/60 text-sm">
    <span data-i18n="foot">© 2025 ISS‑25 Explorer — تجربة تعليمية مفتوحة المصدر. بيانات وصور من وكالات وواجهات عامة.</span>
  </footer>

  <!-- Toast for errors -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-xl shadow-lg z-50"></div>

  <script>
    // ===== i18n =====
    const i18n = {
      ar: {
        brand_over: 'مشروع ويب تفاعلي', brand_title: 'ISS‑25 Explorer',
        nav_track: 'التتبّع الحيّ', nav_timeline: 'الخط الزمني', nav_cupola: 'قبة المحطة', nav_life: 'الحياة على متن ISS',
        hero_h1_1: '25 عامًا في المدار', hero_h1_2: 'محطة الفضاء الدولية',
        hero_sub: 'استكشف تاريخ وإنجازات ISS عبر تتبّع حيّ، خط زمني بصري، وقصص من الحياة اليومية على متن المحطة — كل ذلك في تجربة ويب أنيقة.',
        cta_track: 'ابدأ التتبّع', cta_cupola: 'استكشف القبة',
        cupola_title: 'تجربة قبة المحطة الفضائية (Cupola)', cupola_sub: 'استكشف منظرًا بانوراميًا 360 درجة من القبة، النافذة الأكثر تميزًا على العالم في محطة الفضاء الدولية',
        cupola_info_title: 'معلومات عن القبة', cupola_info_text: 'تمتلك القبة 7 نوافذ وتوفر منظرًا استثنائيًا للأرض. تستخدم لمراقبة عمليات السير في الفضاء وتوجيه الذراع الروبوتية.',
        cupola_auto_rotate: 'تدوير تلقائي', cupola_reset: 'إعادة الضبط', cupola_fullscreen: 'ملء الشاشة',
        cupola_usage_title: 'استخدامات القبة',
        cupola_usage1: 'مراقبة الأرض والظواهر الطبيعية',
        cupola_usage2: 'توجيه العمليات الخارجية والذراع الآلية',
        cupola_usage3: 'التصوير الفلكي والبحث العلمي',
        cupola_usage4: 'إجراء تجارب الرصد الأرضي',
        cupola_facts_title: 'حقائق عن القبة',
        cupola_fact1: 'أضيفت إلى المحطة في عام 2010',
        cupola_fact2: 'النافذة المركزية يبلغ قطرها 80 سم',
        cupola_fact3: 'صممت وبنيت بواسطة وكالة الفضاء الأوروبية',
        cupola_fact4: 'توفر رؤية بزاوية 360 درجة حول المحطة',
        map_title: 'التتبّع الحيّ للمحطة', map_sub: 'موقع لحظي + مسار قادم محسوب محليًا من عناصر المدار (TLE)',
        map_src: 'المصدر: wheretheiss.at للموقع الحيّ، CelesTrak + satellite.js للمسار، خرائط OpenStreetMap/Carto.',
        timeline_title: 'الخط الزمني (2000 → 2025)', reload: 'تحديث',
        life_title: 'الحياة على متن ISS',
        life_sleep_t: 'النوم في الجاذبية الصغرى', life_sleep_d: 'أكياس نوم مثبتة على الجدران لتفادي الطفو أثناء النوم.',
        life_ex_t: 'التمارين اليومية', life_ex_d: 'أجهزة مقاومة وجري للمحافظة على العظام والعضلات.',
        life_food_t: 'الطعام', life_food_d: 'وجبات معبأة خصيصًا وتُسخّن بمعدات مدمجة.',
        life_research_t: 'التجارب العلمية', life_research_d: 'أبحاث في الطب والمواد والبيولوجيا ببيئة انعدام الوزن.',
        foot: '© 2025 ISS‑25 Explorer — تجربة تعليمية مفتوحة المصدر. بيانات وصور من وكالات وواجهات عامة.'
      },
      en: {
        brand_over: 'Interactive Web Project', brand_title: 'ISS‑25 Explorer',
        nav_track: 'Live Tracking', nav_timeline: 'Timeline', nav_cupola: 'Cupola', nav_life: 'Life Aboard',
        hero_h1_1: '25 Years in Orbit', hero_h1_2: 'International Space Station',
        hero_sub: 'Explore ISS history and achievements via live tracking, a visual timeline, and day‑to‑day stories — all in a sleek web experience.',
        cta_track: 'Start Tracking', cta_cupola: 'Explore Cupola',
        cupola_title: 'Cupola Observatory Experience', cupola_sub: 'Explore a 360° panoramic view from the Cupola, the world\'s most spectacular window on the International Space Station',
        cupola_info_title: 'About the Cupola', cupola_info_text: 'The Cupola has 7 windows and provides an exceptional view of Earth. It is used to monitor spacewalks and operate the robotic arm.',
        cupola_auto_rotate: 'Auto Rotate', cupola_reset: 'Reset View', cupola_fullscreen: 'Fullscreen',
        cupola_usage_title: 'Cupola Uses',
        cupola_usage1: 'Earth and natural phenomena observation',
        cupola_usage2: 'Guiding external operations and robotic arm',
        cupola_usage3: 'Astronomical imaging and scientific research',
        cupola_usage4: 'Conducting Earth observation experiments',
        cupola_facts_title: 'Cupola Facts',
        cupola_fact1: 'Added to the station in 2010',
        cupola_fact2: 'The center window is 80 cm in diameter',
        cupola_fact3: 'Designed and built by the European Space Agency',
        cupola_fact4: 'Provides 360-degree viewing around the station',
        map_title: 'Live Station Tracking', map_sub: 'Realtime location + upcoming path computed locally from TLE',
        map_src: 'Sources: wheretheiss.at for live, CelesTrak + satellite.js for path, OpenStreetMap/Carto tiles.',
        timeline_title: 'Timeline (2000 → 2025)', reload: 'Reload',
        life_title: 'Life Aboard ISS',
        life_sleep_t: 'Sleeping in Microgravity', life_sleep_d: 'Sleeping bags anchored to walls to prevent drifting.',
        life_ex_t: 'Daily Exercise', life_ex_d: 'Resistance and treadmill gear to preserve bones and muscles.',
        life_food_t: 'Food', life_food_d: 'Specially packaged meals heated with compact equipment.',
        life_research_t: 'Scientific Experiments', life_research_d: 'Research in medicine, materials, and biology in microgravity.',
        foot: '© 2025 ISS‑25 Explorer — Open educational experience. Media & data from public sources.'
      }
    }

    const htmlEl = document.documentElement;
    const langBtn = document.getElementById('langToggle');
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    function applyLang(lang) {
      const dict = i18n[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
      });
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      langBtn.textContent = (lang === 'ar') ? 'EN' : 'AR';
      localStorage.setItem('issLang', lang);
    }

    function toggleLang() {
      const newLang = htmlEl.lang === 'ar' ? 'en' : 'ar';
      applyLang(newLang);
    }

    function toggleTheme() {
      const isDark = htmlEl.classList.toggle('dark');
      localStorage.setItem('issTheme', isDark ? 'dark' : 'light');
      themeIcon.textContent = isDark ? '🌙' : '☀️';
      
      // تحديث طبقة الخريطة بناءً على السمة
      updateMapTheme(isDark);
    }

    // ===== Map & ISS Tracking =====
    let map, issMarker, issPath, tleData;
    let dayLayer, nightLayer;

    // إنشاء علامة ISS مخصصة
    function createIssIcon() {
      return L.divIcon({
        html: '<div class="iss-icon"></div>',
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // تهيئة الخريطة
    function initMap() {
      // تأكد من وجود عنصر الخريطة أولاً
      if (!document.getElementById('map')) {
        console.error("عنصر الخريطة غير موجود في DOM");
        return;
      }
      
      map = L.map('map', {
        center: [0, 0],
        zoom: 2,
        minZoom: 1,
        maxBounds: [[-90, -180], [90, 180]],
        maxBoundsViscosity: 1.0
      });

      // إنشاء طبقات الخريطة
      dayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
      });

      nightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      });

      // تطبيق الطبقة المناسبة بناءً على السمة الحالية
      const isDark = localStorage.getItem('issTheme') !== 'light';
      if (isDark) {
        nightLayer.addTo(map);
      } else {
        dayLayer.addTo(map);
      }

      issMarker = L.marker([0, 0], { icon: createIssIcon() }).addTo(map);
      issPath = L.polyline([], { color: '#3b82f6', weight: 2, opacity: 0.7 }).addTo(map);

      // جلب بيانات الموقع والمسار
      fetchISSData();
      fetchTLE();
    }

    // تحديث سمة الخريطة
    function updateMapTheme(isDark) {
      if (!map) return;
      
      if (isDark) {
        if (map.hasLayer(dayLayer)) {
          map.removeLayer(dayLayer);
        }
        nightLayer.addTo(map);
      } else {
        if (map.hasLayer(nightLayer)) {
          map.removeLayer(nightLayer);
        }
        dayLayer.addTo(map);
      }
    }

    // جلب بيانات الموقع الحالي
    async function fetchISSData() {
      try {
        const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
        if (!response.ok) throw new Error('فشل في جلب بيانات الموقع');
        
        const data = await response.json();
        const { latitude, longitude, altitude, velocity } = data;
        
        // تحديث الموقع
        issMarker.setLatLng([latitude, longitude]);
        map.panTo([latitude, longitude], { animate: true, duration: 1 });
        
        // تحديث معلومات الجانبية
        updateSidebarData(latitude, longitude, altitude, velocity);
        
      } catch (error) {
        console.error('خطأ في جلب بيانات ISS:', error);
        showToast('تعذر تحديث موقع المحطة. جاري إعادة المحاولة...');
      }
      
      // جدولة التحديث التالي
      setTimeout(fetchISSData, 3000);
    }

    // جلب بيانات TLE للمسار
    async function fetchTLE() {
      try {
        // التحقق من وجود مكتبة satellite.js
        if (typeof satellite === 'undefined') {
          throw new Error('مكتبة satellite.js غير محملة');
        }
        
        const response = await fetch('https://celestrak.org/NORAD/elements/gp.php?CATNR=25544');
        if (!response.ok) throw new Error('فشل في جلب بيانات TLE');
        
        const text = await response.text();
        const lines = text.trim().split('\n');
        
        if (lines.length >= 3) {
          tleData = {
            name: lines[0].trim(),
            line1: lines[1],
            line2: lines[2]
          };
          updatePath();
        }
      } catch (error) {
        console.error('خطأ في جلب بيانات TLE:', error);
        showToast('تعذر تحديث مسار المحطة. جاري إعادة المحاولة...');
      }
      
      // جدولة التحديث التالي
      setTimeout(fetchTLE, 60000);
    }

    // تحديث مسار المحطة
    function updatePath() {
      if (!tleData || typeof satellite === 'undefined') return;
      
      try {
        const satrec = satellite.twoline2satrec(tleData.line1, tleData.line2);
        const now = new Date();
        const points = [];
        
        // حساب النقاط للمسار القادم (90 دقيقة)
        for (let min = 0; min < 90; min += 5) {
          const future = new Date(now.getTime() + min * 60000);
          const positionAndVelocity = satellite.propagate(satrec, future);
          const positionEci = positionAndVelocity.position;
          
          if (positionEci) {
            const gmst = satellite.gstime(future);
            const positionGd = satellite.eciToGeodetic(positionEci, gmst);
            const longitude = satellite.degreesLong(positionGd.longitude);
            const latitude = satellite.degreesLat(positionGd.latitude);
            
            points.push([latitude, longitude]);
          }
        }
        
        issPath.setLatLngs(points);
      } catch (error) {
        console.error('خطأ في حساب المسار:', error);
        showToast('خطأ في حساب مسار المحطة');
      }
    }

    // تحديث المعلومات الجانبية
    function updateSidebarData(lat, lng, alt, vel) {
      const latEl = document.getElementById('iss-lat');
      const lngEl = document.getElementById('iss-lng');
      const altEl = document.getElementById('iss-alt');
      const velEl = document.getElementById('iss-vel');
      
      if (latEl) latEl.textContent = lat.toFixed(4);
      if (lngEl) lngEl.textContent = lng.toFixed(4);
      if (altEl) altEl.textContent = Math.round(alt).toLocaleString();
      if (velEl) velEl.textContent = Math.round(vel).toLocaleString();
    }

    // عرض رسائل الخطأ
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // ===== Timeline (NASA Image & Video Library) =====
    const timelineEl = document.getElementById('timeline');
    
    function timelineSkeleton(){
      timelineEl.innerHTML = '';
      for(let i=0;i<6;i++){
        const s = document.createElement('div');
        s.className = 'rounded-2xl border border-white/10 p-3 animate-pulse bg-white/5 h-28';
        timelineEl.appendChild(s);
      }
    }

    async function loadTimeline(){
      timelineSkeleton();
      try{
        const q = encodeURIComponent('International Space Station');
        const r = await fetch(`https://images-api.nasa.gov/search?q=${q}&media_type=image&year_start=2000&year_end=2025`);
        const d = await r.json();
        const items = (d.collection?.items || []).slice(0, 12);
        timelineEl.innerHTML = '';
        items.forEach(it => {
          const data = it.data?.[0]; const link = it.links?.[0]?.href;
          if(!data || !link) return;
          const card = document.createElement('article');
          card.className = 'timeline-card rounded-2xl border border-white/10 overflow-hidden bg-white/5 hover:bg-white/10 transition';
          card.innerHTML = `
            <img class="timeline-image w-full h-40 object-cover" src="${link}" alt="${(data.title||'ISS Image').replace(/"/g,'&quot;')}" loading="lazy"/>
            <div class="p-3">
              <h4 class="font-semibold text-sm">${data.title||''}</h4>
              <p class="text-xs text-white/60">${(data.date_created||'').slice(0,10)}</p>
            </div>`;
          timelineEl.appendChild(card);
        });
      }catch(e){
        showToast('تعذر تحميل الخط الزمني / Timeline failed');
        // عرض بيانات افتراضية في حالة فشل التحميل
        loadDefaultTimeline();
      }
    }

    function loadDefaultTimeline() {
      const defaultData = [
        { title: "ISS from SpaceX Dragon", date: "2022-05-21", image: "https://images-assets.nasa.gov/image/iss067e006450/iss067e006450~thumb.jpg" },
        { title: "Astronaut on Spacewalk", date: "2021-03-13", image: "https://images-assets.nasa.gov/image/iss065e015655/iss065e015655~thumb.jpg" },
        { title: "Cupola Observation Module", date: "2020-11-02", image: "https://images-assets.nasa.gov/image/iss050e023918/iss050e023918~thumb.jpg" },
        { title: "Space Station Solar Arrays", date: "2019-08-15", image: "https://images-assets.nasa.gov/image/iss060e085359/iss060e085359~thumb.jpg" },
        { title: "Earth from ISS", date: "2018-06-30", image: "https://images-assets.nasa.gov/image/iss056e076337/iss056e076337~thumb.jpg" },
        { title: "ISS Construction", date: "2010-05-17", image: "https://images-assets.nasa.gov/image/iss023e058236/iss023e058236~thumb.jpg" }
      ];
      
      timelineEl.innerHTML = '';
      defaultData.forEach(item => {
        const card = document.createElement('article');
        card.className = 'timeline-card rounded-2xl border border-white/10 overflow-hidden bg-white/5 hover:bg-white/10 transition';
        card.innerHTML = `
          <img class="timeline-image w-full h-40 object-cover" src="${item.image}" alt="${item.title}" loading="lazy"/>
          <div class="p-3">
            <h4 class="font-semibold text-sm">${item.title}</h4>
            <p class="text-xs text-white/60">${item.date}</p>
          </div>`;
        timelineEl.appendChild(card);
      });
    }

    // ===== Cupola 360 Viewer =====
    let scene, camera, renderer, controls, video, videoTexture, videoMesh;
    let isAutoRotating = true;
    let isPlaying = true;
    let isMuted = false;
    let currentScene = 0;
    
    // مصادر الفيديو والصور
    const scenes = [
      { type: 'video', src: 'Cupola2.mp4', poster: 'images/cupola1-poster.jpg' },
      { type: 'video', src: '2402_001_AR_EN.mp4', poster: 'images/cupola2-poster.jpg' },
      { type: 'image', src: 'iss038-2.jpg' },
      { type: 'image', src: 'iss038.jpg' }
    ];

    function initCupolaViewer() {
      // إنشاء المشهد والكاميرا والعارض
      scene = new THREE.Scene();
      
      // إنشاء كاميرا ذات منظور واسع
      const container = document.getElementById('cupola-container');
      camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
      camera.position.set(0, 0, 0.1);
      
      // إنشاء العارض
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.offsetWidth, container.offsetHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);
      
      // إضافة عناصر التحكم
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.rotateSpeed = 0.5;
      controls.enableZoom = true;
      controls.enablePan = false;
      
      // تحميل المشهد الأول
      loadScene(currentScene);
      
      // إضافة معالج الأحداث لأزرار التحكم
      document.getElementById('auto-rotate').addEventListener('click', function() {
        isAutoRotating = !isAutoRotating;
        this.textContent = isAutoRotating ? 
          (htmlEl.lang === 'ar' ? 'إيقاف التدوير' : 'Stop Rotation') : 
          (htmlEl.lang === 'ar' ? 'تدوير تلقائي' : 'Auto Rotate');
      });
      
      document.getElementById('reset-view').addEventListener('click', function() {
        controls.reset();
      });
      
      document.getElementById('fullscreen').addEventListener('click', function() {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      });
      
      // أزرار التكبير/التصغير
      document.getElementById('zoom-in').addEventListener('click', function() {
        controls.dollyOut(0.5);
      });
      
      document.getElementById('zoom-out').addEventListener('click', function() {
        controls.dollyIn(0.5);
      });
      
      // أزرار التحكم في الفيديو
      document.getElementById('play-pause').addEventListener('click', function() {
        togglePlayPause();
      });
      
      document.getElementById('mute-unmute').addEventListener('click', function() {
        toggleMute();
      });
      
      // أزرار تغيير المشاهد
      for (let i = 1; i <= 4; i++) {
        document.getElementById(`scene${i}`).addEventListener('click', function() {
          switchScene(i - 1);
        });
      }
      
      // معالجة تغيير حجم النافذة
      window.addEventListener('resize', onWindowResize, false);
    }

    function loadScene(sceneIndex) {
      // إظهار مؤشر التحميل
      document.getElementById('loading-overlay').style.display = 'flex';
      
      // إزالة المشهد الحالي إذا كان موجودًا
      if (videoMesh) {
        scene.remove(videoMesh);
      }
      
      // تنظيف موارد الفيديو السابقة
      if (video) {
        video.pause();
        video.removeAttribute('src');
        video.load();
      }
      
      const sceneData = scenes[sceneIndex];
      
      if (sceneData.type === 'video') {
        loadVideoScene(sceneData);
      } else {
        loadImageScene(sceneData);
      }
    }

    function loadVideoScene(sceneData) {
      // إنشاء عنصر فيديو
      video = document.createElement('video');
      video.loop = true;
      video.muted = isMuted;
      video.preload = 'auto';
      video.playsInline = true;
      
      // تحديث زر كتم الصوت
      updateMuteButton();
      
      video.addEventListener('loadeddata', function() {
        // إنشاء نسيج الفيديو
        videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;
        videoTexture.format = THREE.RGBFormat;
        
        // إنشاء material للمشهد
        const geometry = new THREE.SphereGeometry(500, 60, 40);
        const material = new THREE.MeshBasicMaterial({
          map: videoTexture,
          side: THREE.BackSide
        });
        
        // إنشاء mesh وإضافته إلى المشهد
        videoMesh = new THREE.Mesh(geometry, material);
        scene.add(videoMesh);
        
        // تشغيل الفيديو
        video.play();
        isPlaying = true;
        updatePlayButton();
        
        // إخفاء مؤشر التحميل
        document.getElementById('loading-overlay').style.display = 'none';
      });
      
      video.addEventListener('error', function(e) {
        console.error('Error loading video:', e);
        showToast('تعذر تحميل الفيديو. جاري استخدام صورة بديلة...');
        
        // استخدام صورة بديلة
        const backupImage = new THREE.TextureLoader().load('https://images-assets.nasa.gov/image/ISS030-E-015472/ISS030-E-015472~orig.jpg');
        const geometry = new THREE.SphereGeometry(500, 60, 40);
        const material = new THREE.MeshBasicMaterial({
          map: backupImage,
          side: THREE.BackSide
        });
        
        videoMesh = new THREE.Mesh(geometry, material);
        scene.add(videoMesh);
        
        document.getElementById('loading-overlay').style.display = 'none';
      });
      
      // تحميل الفيديو
      video.src = sceneData.src;
      video.load();
      
      // تحديث حالة الأزرار
      updateSceneButtons();
    }

    function loadImageScene(sceneData) {
      const loader = new THREE.TextureLoader();
      
      loader.load(
        sceneData.src,
        function(texture) {
          // إنشاء material للمشهد
          const geometry = new THREE.SphereGeometry(500, 60, 40);
          const material = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.BackSide
          });
          
          // إنشاء mesh وإضافته إلى المشهد
          videoMesh = new THREE.Mesh(geometry, material);
          scene.add(videoMesh);
          
          // إخفاء مؤشر التحميل
          document.getElementById('loading-overlay').style.display = 'none';
          
          // تحديث حالة الأزرار
          updateSceneButtons();
        },
        undefined,
        function(err) {
          console.error('Error loading image:', err);
          showToast('تعذر تحميل الصورة. جاري استخدام صورة بديلة...');
          
          // استخدام صورة بديلة
          const backupImage = new THREE.TextureLoader().load('https://images-assets.nasa.gov/image/ISS030-E-015472/ISS030-E-015472~orig.jpg');
          const geometry = new THREE.SphereGeometry(500, 60, 40);
          const material = new THREE.MeshBasicMaterial({
            map: backupImage,
            side: THREE.BackSide
          });
          
          videoMesh = new THREE.Mesh(geometry, material);
          scene.add(videoMesh);
          
          document.getElementById('loading-overlay').style.display = 'none';
          updateSceneButtons();
        }
      );
    }

    function togglePlayPause() {
      if (scenes[currentScene].type === 'video' && video) {
        if (isPlaying) {
          video.pause();
        } else {
          video.play();
        }
        isPlaying = !isPlaying;
        updatePlayButton();
      }
    }

    function toggleMute() {
      if (scenes[currentScene].type === 'video' && video) {
        video.muted = !video.muted;
        isMuted = video.muted;
        updateMuteButton();
      }
    }

    function updatePlayButton() {
      const playButton = document.getElementById('play-pause');
      if (playButton) {
        playButton.innerHTML = isPlaying ? '⏸️' : '▶️';
        playButton.title = isPlaying ? 'إيقاف' : 'تشغيل';
      }
    }

    function updateMuteButton() {
      const muteButton = document.getElementById('mute-unmute');
      if (muteButton) {
        muteButton.innerHTML = isMuted ? '🔇' : '🔊';
        muteButton.title = isMuted ? 'إلغاء كتم الصوت' : 'كتم الصوت';
      }
    }

    function updateSceneButtons() {
      document.querySelectorAll('.scene-btn').forEach((btn, index) => {
        if (index === currentScene) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // إظهار/إخفاء أزرار التحكم في الفيديو
      const videoControls = document.querySelector('.video-controls');
      if (videoControls) {
        videoControls.style.display = scenes[currentScene].type === 'video' ? 'flex' : 'none';
      }
    }

    function switchScene(sceneIndex) {
      if (sceneIndex !== currentScene) {
        currentScene = sceneIndex;
        loadScene(currentScene);
      }
    }

    function onWindowResize() {
      if (camera && renderer) {
        const container = document.getElementById('cupola-container');
        camera.aspect = container.offsetWidth / container.offsetHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.offsetWidth, container.offsetHeight);
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      
      if (isAutoRotating) {
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
      } else {
        controls.autoRotate = false;
      }
      
      // تحديث نسيج الفيديو إذا كان مشغلاً
      if (videoTexture && video && isPlaying) {
        videoTexture.needsUpdate = true;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }

    // ===== Initialize Everything =====
    function initializeApp() {
      // تهيئة اللغة والسمة
      const savedLang = localStorage.getItem('issLang') || 'ar';
      const savedTheme = localStorage.getItem('issTheme') || 'dark';
      
      applyLang(savedLang);
      if (savedTheme === 'light') {
        htmlEl.classList.remove('dark');
        themeIcon.textContent = '☀️';
      }

      // تهيئة الخريطة بعد تحميل DOM
      initMap();
      loadTimeline();
      
      // تهيئة عارض القبة
      initCupolaViewer();
      
      // بدء التقديم
      animate();
      
      // إضافة مستمع حدث لإعادة تحميل الجدول الزمني
      document.getElementById('reloadTimeline')?.addEventListener('click', loadTimeline);
      
      // إضافة مستمعي الأحداث للأزرار
      langBtn.addEventListener('click', toggleLang);
      themeBtn.addEventListener('click', toggleTheme);
    }

    // الانتظار حتى يتم تحميل جميع الموارد
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }

    // معالجة أخطاء تحميل المكتبات
    window.addEventListener('error', (e) => {
      if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
        showToast('خطأ في تحميل الموارد. يرجى التحقق من اتصال الإنترنت.');
        console.error('خطأ في تحميل المورد:', e.target.src || e.target.href);
      }
    });
  </script>
</body>
</html>
